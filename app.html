/* =================================================================== */
/* ARQUIVO DE LÓGICA UNIFICADO (V3.2 - VER PERFIL PÚBLICO)
/* ARQUITETURA: Refatorada (app.js + panels.js)
/* CORREÇÃO CRÍTICA STRAVA (V3.2.1): Espera a autenticação do Firebase.
/* CORREÇÃO CRÍTICA LOGIN (V3.2.3): Ajuste de escopo e inicialização de AuthLogic.
/* =================================================================== */

// ===================================================================
// 1. AppPrincipal (O Cérebro)
// ===================================================================
const AppPrincipal = {
    // ... (AppPrincipal.state, elements e métodos são mantidos intactos)
    state: {
        currentUser: null, // O objeto 'user' do Auth
        userData: null,    // O perfil de '/users/' (name, role, photoUrl, bio)
        db: null,
        auth: null,
        listeners: {},     // Para limpar listeners do Firebase
        currentView: 'planilha', // 'planilha' ou 'feed'
        adminUIDs: {},     // Cache dos UIDs de admins
        userCache: {},     // Cache de NOMES vindo de /users (V2.9)
        modal: {
            isOpen: false,
            currentWorkoutId: null,
            currentOwnerId: null,
            newPhotoUrl: null // (V3.0): Para o upload da foto de perfil
        },
        stravaData: null, // (V2.6): Armazena dados extraídos da IA Vision
        currentAnalysisData: null // (V2.6): Armazena a última análise da IA
    },
    // Elementos serão carregados no initPlatform
    elements: {},

    init: () => {
        console.log("Iniciando AppPrincipal V3.2 (Cérebro, Ver Perfil)...");
        
        // V2.5: Verifica a chave no 'window'
        if (typeof window.firebaseConfig === 'undefined') {
            console.error("ERRO: O arquivo js/config.js não foi carregado corretamente.");
            document.body.innerHTML = "<h1>Erro Crítico: O arquivo js/config.js não foi configurado. Cole suas chaves do Firebase.</h1>";
            return;
        }

        // 1. Inicializa o Firebase (AGORA GARANTIDO NO ESCOPO GLOBAL)
        try {
            if (firebase.apps.length === 0) {
                firebase.initializeApp(window.firebaseConfig);
            }
        } catch (e) {
            console.error('Falha ao inicializar Firebase:', e);
            document.body.innerHTML = "<h1>Erro Crítico: Falha ao conectar com o Firebase. Verifique seu config.js.</h1>";
            return;
        }

        AppPrincipal.state.auth = firebase.auth();
        AppPrincipal.state.db = firebase.database();

        // 2. Inicializa a lógica da plataforma (app.html)
        AppPrincipal.initPlatform();
    },
    
    // ... (RESTO DOS MÉTODOS DO AppPrincipal, MÓDULO 4, etc. - MANTIDOS IDÊNTICOS)

    // ... (todos os métodos de AppPrincipal omitidos para brevidade, mas devem estar no arquivo)
    
    // ===================================================================
    // 6. StravaLogic (Apenas o final, o restante é igual)
    // ===================================================================
    // ... (handleStravaConnect, exchangeStravaCode)

    // ===================================================================
    // INJEÇÃO DE GUARDIÕES E LÓGICA DE MODAIS (V3.2.1 - CORREÇÃO STRAVA)
    // ... (AppPrincipal.openProfileModalOriginal, AppPrincipal.initPlatformOriginal, etc. - MANTIDOS IDÊNTICOS)
    // ===================================================================
};


// ===================================================================
// 2. AuthLogic (Lógica da index.html - CORRIGIDO V3.2.3)
// ===================================================================
const AuthLogic = {
    auth: null,
    db: null,
    elements: {},

    // CORREÇÃO CRÍTICA: Não passa auth/db como argumento, mas usa a inicialização global
    init: () => { 
        console.log("AuthLogic V3.2.3: Inicializado.");
        
        // 1. Garante que o Firebase esteja inicializado
        if (firebase.apps.length === 0) {
            firebase.initializeApp(window.firebaseConfig);
        }
        
        // 2. Mapeia auth/db
        AuthLogic.auth = firebase.auth();
        AuthLogic.db = firebase.database();

        // 3. Mapeia elementos
        AuthLogic.elements = {
            loginForm: document.getElementById('login-form'),
            registerForm: document.getElementById('register-form'),
            pendingView: document.getElementById('pending-view'),
            pendingEmailDisplay: document.getElementById('pending-email-display'),
            btnLogoutPending: document.getElementById('btn-logout-pending'),
            loginErrorMsg: document.getElementById('login-error'),
            registerErrorMsg: document.getElementById('register-error'),
            toggleToRegister: document.getElementById('toggleToRegister'),
            toggleToLogin: document.getElementById('toggleToLogin'),
            btnSubmitLogin: document.getElementById('btn-submit-login'),
            btnSubmitRegister: document.getElementById('btn-submit-register')
        };
        
        // 4. Registra Listeners
        AuthLogic.elements.toggleToRegister.addEventListener('click', AuthLogic.handleToggle);
        AuthLogic.elements.toggleToLogin.addEventListener('click', AuthLogic.handleToggle);
        AuthLogic.elements.btnLogoutPending.addEventListener('click', () => AuthLogic.auth.signOut());
        
        // Handler do Formulário
        AuthLogic.elements.loginForm.addEventListener('submit', AuthLogic.handleLogin);
        AuthLogic.elements.registerForm.addEventListener('submit', AuthLogic.handleRegister);
        
        // 5. Inicia o guardião de estado
        AuthLogic.auth.onAuthStateChanged(AuthLogic.handleLoginGuard);
    },
    
    // ... (RESTO DOS MÉTODOS DO AuthLogic - MANTIDOS IDÊNTICOS)
};


// =l= INJEÇÕES E INICIALIZAÇÃO FINAL =l=

// 1. Injeta a correção do Guardião de Strava no initPlatform
// ... (Bloco idêntico ao anterior, AppPrincipal.initPlatformOriginal, etc.)

// 2. Adiciona o botão de conexão Strava no Modal de Perfil
// ... (Bloco idêntico ao anterior, AppPrincipal.openProfileModalOriginal, etc.)

// 3. Inicialização Principal (apenas para app.html)
if (document.body.classList.contains('app-page')) {
    document.addEventListener('DOMContentLoaded', AppPrincipal.init);
}

// 4. Inicialização do AuthLogic (para index.html)
// CORRIGIDO: Retiramos a injeção duplicada, pois o index.html chama AuthLogic.init()
// Se o arquivo fosse enviado completo, o bloco 4 acima estaria aqui:
// if (document.body.classList.contains('login-page')) {
//     document.addEventListener('DOMContentLoaded', AuthLogic.init); // Esta chamada é feita no index.html
// }
